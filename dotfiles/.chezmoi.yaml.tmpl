{{- $_profile := "profile" | index . | default dict -}}
{{- $work := promptBoolOnce $_profile "work" "Work" false -}}
{{- $poshTheme := "new-theme.omp.yaml" -}}

{{- $_defaultFont := dict 
      "family" "Hack Nerd Font Mono"
      "size" (eq "windows" .chezmoi.os | ternary 11 14)
-}}
{{- $font := $_defaultFont | merge ("font" | index . | default dict) -}}

{{- $_defaultGitCredentialManager := dict
    "configure" true
    "install" ("linux" | eq .chezmoi.os)
-}}
{{- if eq "linux" .chezmoi.os -}}
{{-   $_defaultGitCredentialManager = set $_defaultGitCredentialManager "store" "plaintext" -}}
{{- end -}}
{{- $gitCredentialManager := $_defaultGitCredentialManager | merge ("gitCredentialManager" | index . | default dict) -}}

{{- $_local := ".local" -}}
{{- $_localInstall := joinPath $_local "opt" -}}
{{- $_localInstallBin := joinPath $_local "bin" -}}
{{- $_localInstallSbin := joinPath $_local "sbin" -}}
{{- $_dataHome := joinPath $_local "share" -}}
{{- $_configHome := ".config" -}}
{{- $_cacheHome := ".cache" -}}
{{- $_ipython := joinPath $_configHome "ipython" -}}
{{- $_zshConfig := joinPath $_configHome "zsh" -}}
{{- $_zshPlugins := joinPath $_zshConfig "plugins" -}}
{{- $_fzf := joinPath $_localInstall "fzf" -}}
{{- $_fzfBin := joinPath $_fzf "bin" -}}
{{- $_relativePaths := dict
      "local" $_local
      "localInstall" $_localInstall
      "localInstallBin" $_localInstallBin
      "localInstallSbin" $_localInstallSbin
      "dataHome" $_dataHome
      "configHome" $_configHome
      "cacheHome" $_cacheHome
      "ipython" $_ipython
      "zshConfig" $_zshConfig
      "zshPlugins" $_zshPlugins
      "fzf" $_fzf
      "fzfBin" $_fzfBin
-}}
{{- $_platformRelativePaths := dict }}
{{- if eq "windows" .chezmoi.os -}}
{{-   $_bash := joinPath "C:\\" "Program Files" "git" "bin" "bash.exe" }}
{{-   $_platformRelativePaths = dict
        "bash" $_bash
-}}
{{- else if eq "linux" .chezmoi.os -}}
{{-   $_asdf := ".asdf" -}}
{{-   $_platformRelativePaths = dict
        "asdf" $_asdf
-}}
{{- else if eq "darwin" .chezmoi.os -}}
{{-   $_homebrew := "/opt/homebrew" -}}
{{-   $_platformRelativePaths = dict
        "homebrew" $_homebrew
-}}
{{- end -}}
{{- if $gitCredentialManager.install -}}
{{-    $_gitCredentialManagerPath := joinPath $_localInstall "git-credential-manager" -}}
{{-    $_platformRelativePaths = set $_platformRelativePaths "gitCredentialManager" $_gitCredentialManagerPath -}}
{{- end -}}
{{- $_relativePaths = merge $_relativePaths $_platformRelativePaths }}
{{- $paths := dict -}}
{{- range $k, $v := $_relativePaths -}}
{{-   $paths = set $paths $k ($v | osIsAbs | ternary $v (joinPath $.chezmoi.homeDir $v)) -}}
{{- end -}}
{{- $paths = set $paths "relative" $_relativePaths -}}

data:
  profile:
    work: {{ $work }}
  font:
    family: {{ $font.family }}
    size: {{ $font.size }}
  gitCredentialManager:
{{  $gitCredentialManager | toYaml | indent 4 }}
  paths:
{{ $paths | toYaml | indent 4 }}
    unix:
{{ includeTemplate "dotfiles/.chezmoitemplates/buildUnixPaths" (dict "chezmoi" .chezmoi "paths" $paths) | indent 6 }}
  environment:
    - name: AWS_PROFILE
      action: unset
    - name: KUBECONFIG
      action: unset
    - name: GPG_TTY
      action: command
      value: tty
    - name: IPYTHONDIR
      path: true
      value: {{ $paths.ipython }}
    - name: LOCAL_INSTALL_DIR
      path: true
      value: {{ $paths.localInstall }}
      export: false
    - name: POSH_THEME
      path: true
      value: {{ joinPath $paths.configHome "oh-my-posh" $poshTheme }}
    - name: XDG_DATA_HOME
      path: true
      persist: true
      value: {{ $paths.dataHome }}
    - name: XDG_CONFIG_HOME
      path: true
      persist: true
      value: {{ $paths.configHome }}
    - name: XDG_CACHE_HOME
      path: true
      persist: true
      value: {{ $paths.cacheHome }}
{{- if "asdf" | hasKey $paths }}
    - name: ASDF_DIR
      value: {{ $paths.asdf }}
    - name: ASDF_DATA_DIR
      value: {{ $paths.asdf }}
{{- end }}
    - name: PATH
      path: true
      action: prepend
      persist: true
      value:
        - {{ $paths.localInstallBin }}
        - {{ $paths.fzfBin }}
{{- if "homebrew" | index $paths }}
        - {{ "bin" | joinPath $paths.homebrew }}
{{- end }}

umask: 0o022

{{- if eq .chezmoi.os "windows" }}
interpreters:
  sh:
    command: {{ $paths.bash }}
  ps1:
    command: pwsh
    args:
      - "-NoLogo"

cd:
  command: pwsh
{{- end  }}
