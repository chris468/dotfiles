chezmoi:template:missing-key=zero
{{- $platform := eq .chezmoi.os "windows" | ternary "windows" "linux" -}}
{{- includeTemplate (joinPath "software-installer" $platform "before-install-loop") . }}
{{- range $spec := .software.packages }}
{{-   $spec = $spec | default (dict) }}
{{-   $osSpec := $.chezmoi.os | index $spec }}
{{-   $osSpec = $osSpec | eq nil | ternary $spec.default $osSpec }}
{{-   $osSpec = $osSpec | eq nil | ternary (dict) $osSpec }}
{{-   if $osSpec | kindIs "map" }}
{{-     $spec = $spec | merge ($osSpec | deepCopy) }}
{{-     $doInstall := (or (not $spec.group) (index $ $spec.group)) }}
{{-     $version := $spec.name | index $.software.versions }}
{{-     if $version | kindIs "map" }}
{{-       $version = $.chezmoi.os | index $version }}
{{-       $version = $.chezmoi.os | eq nil | ternary $version.default $version }}
{{-     end }}
{{-     $info := dict
          "chezmoi" $.chezmoi
          "package" ($spec.package | default $spec.name)
          "spec" (merge $spec (dict "version" $version))
          "doInstall" $doInstall
}}
{{-     range (list $platform "common") }}
{{-       includeTemplate (joinPath "software-installer" . "in-install-loop") $info }}
{{-     end }}
{{-   end }}
{{- end }}
{{- range (list $platform "common") }}
{{-   includeTemplate (joinPath "software-installer" . "after-install-loop") $ }}
{{- end }}
