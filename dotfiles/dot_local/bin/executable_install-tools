#!/usr/bin/env bash

[[ "$(uname -o)" != "Msys" ]] || exec pwsh -nologo $HOME/.local/bin/install-tools.ps1 "$@"

function install_Darwin() {
  local category="$1"
  local -a packages_file="$XDG_DATA_HOME/chris468/tools/$category/darwin/brew.txt"
  [[ -f "$packages_file" ]] || return

  local -a packages=($(cat "$packages_file"))
  [[ ${#packages[@]} -gt 0 ]] || return

  echo
  echo "Installing $category tool homebrew packages..."
  brew install "${packages[@]}"
}

function install_nerd_font() {
  local category="$1"
  local -a fonts_file="$XDG_DATA_HOME/chris468/tools/$category/nerdfonts.txt"
  [[ -f "$fonts_file" ]] || return

  local -a fonts=($(cat "$fonts_file"))
  [[ ${#fonts[@]} -gt 0 ]] || return

  echo
  echo "Installing $category nerd fonts..."
  for font in "${fonts[@]}"; do
    oh-my-posh font install "$font"
  done
}

declare -ar ORDER=(essential container kubernetes aws azure)
ALL=
ANY=
FONTS=1
for category in "${ORDER[@]}"; do
  declare "category_$category"
done

while [[ $# -gt 0 ]]; do
  case "$1" in
  --all)
    ALL=1
    break
    ;;

  --no-fonts)
    FONTS=
    shift
    ;;

  --*)
    c="${1#--}"
    [[ -d "$XDG_DATA_HOME/chris468/tools/$c" ]] || {
      echo "Unknown option: $1" >&2
      exit 1
    }

    declare "category_$c"=1
    ANY=1
    shift
    ;;

  *)
    echo "Unknown option: $1" >&2
    exit 1
    ;;
  esac
done

[[ -n "$ANY" ]] || category_essential=1

OS=$(uname -o)
for category in "${ORDER[@]}"; do
  v="category_$category"
  [[ -n "$ALL" ]] || [[ -n "${!v}" ]] || continue
  install_$OS $category
  [[ -z "$FONTS" ]] || install_nerd_font $category
done
