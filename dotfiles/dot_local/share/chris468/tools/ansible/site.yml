---
- name: Install system tools (local)
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    tools_file: >-
      {{
        lookup('env', 'XDG_DATA_HOME')
          | default(lookup('env','HOME') + '/.local/share', true)
      }}/chris468/tools/tools.yaml
    categories:
      - essential
    use_nix: false

  tasks:
    - name: Normalize categories list
      ansible.builtin.set_fact:
        categories_list: "{{ (categories is string) | ternary(categories | from_yaml, categories) }}"

    - name: Load tool definitions
      ansible.builtin.include_vars:
        file: "{{ tools_file }}"
        name: tools_data

    - name: Compute platform keys
      ansible.builtin.set_fact:
        os_key: >-
          {{
            'windows' if ansible_facts['system'] == 'Windows'
            else 'macos' if ansible_facts['system'] == 'Darwin'
            else 'linux'
          }}
        linux_pkg_key: >-
          {{
            'apt' if ansible_facts['os_family'] == 'Debian'
            else 'dnf' if ansible_facts['os_family'] == 'RedHat'
            else 'pacman' if ansible_facts['distribution'] in ['Archlinux', 'Arch Linux', 'Manjaro']
            else 'zypper' if ansible_facts['os_family'] == 'Suse'
            else 'default'
          }}

    - name: Set nix PATH
      ansible.builtin.set_fact:
        nix_path: >-
          {{
            ansible_facts['env']['HOME'] + '/.nix-profile/bin' +
            ':/nix/var/nix/profiles/default/bin:' +
            ansible_facts['env']['PATH']
          }}


    - name: Build package lists
      ansible.builtin.set_fact:
        os_packages: >-
          {%- set pkgs = [] -%}
          {%- for cat in categories_list -%}
          {%-   set cat_tools = tools_data.tools.get(cat, {}) -%}
          {%-   for name, meta in cat_tools.items() -%}
          {%-     set prefer = meta.get('prefer', {}).get(os_key, {}) -%}
          {%-     set preferred_manager = '' -%}
          {%-     if os_key == 'linux' and prefer is mapping -%}
          {%-       if ansible_facts['os_family'] == 'Debian' -%}
          {%-         set preferred_manager = prefer.get('debian', '') -%}
          {%-       elif ansible_facts['distribution'] in ['Archlinux', 'Arch Linux', 'Manjaro'] -%}
          {%-         set preferred_manager = prefer.get('arch', '') -%}
          {%-       else -%}
          {%-         set preferred_manager = prefer.get('default', '') -%}
          {%-       endif -%}
          {%-     elif prefer is string -%}
          {%-       set preferred_manager = prefer -%}
          {%-     endif -%}
          {%-     if preferred_manager != 'nix' -%}
          {%-       set os_pkgs = meta.get('packages', {}).get('os', {}) -%}
          {%-       if os_key == 'windows' -%}
          {%-         set pkg = os_pkgs.get('windows', '') -%}
          {%-       elif os_key == 'macos' -%}
          {%-         set pkg = os_pkgs.get('macos', '') -%}
          {%-       else -%}
          {%-         set linux_pkgs = os_pkgs.get('linux', {}) -%}
          {%-         set pkg = linux_pkgs.get(linux_pkg_key, linux_pkgs.get('default', '')) -%}
          {%-       endif -%}
          {%-       if pkg -%}
          {%-         set _ = pkgs.append(pkg) -%}
          {%-       endif -%}
          {%-     endif -%}
          {%-   endfor -%}
          {%- endfor -%}
          {{ pkgs | unique | sort }}
        nix_packages: >-
          {%- set pkgs = [] -%}
          {%- for cat in categories_list -%}
          {%-   set cat_tools = tools_data.tools.get(cat, {}) -%}
          {%-   for name, meta in cat_tools.items() -%}
          {%-     set prefer = meta.get('prefer', {}).get(os_key, {}) -%}
          {%-     set preferred_manager = '' -%}
          {%-     if os_key == 'linux' and prefer is mapping -%}
          {%-       if ansible_facts['os_family'] == 'Debian' -%}
          {%-         set preferred_manager = prefer.get('debian', '') -%}
          {%-       elif ansible_facts['distribution'] in ['Archlinux', 'Arch Linux', 'Manjaro'] -%}
          {%-         set preferred_manager = prefer.get('arch', '') -%}
          {%-       else -%}
          {%-         set preferred_manager = prefer.get('default', '') -%}
          {%-       endif -%}
          {%-     elif prefer is string -%}
          {%-       set preferred_manager = prefer -%}
          {%-     endif -%}
          {%-     set os_pkgs = meta.get('packages', {}).get('os', {}) -%}
          {%-     if os_key == 'windows' -%}
          {%-       set os_pkg = os_pkgs.get('windows', '') -%}
          {%-     elif os_key == 'macos' -%}
          {%-       set os_pkg = os_pkgs.get('macos', '') -%}
          {%-     else -%}
          {%-       set linux_pkgs = os_pkgs.get('linux', {}) -%}
          {%-       set os_pkg = linux_pkgs.get(linux_pkg_key, linux_pkgs.get('default', '')) -%}
          {%-     endif -%}
          {%-     set nix_pkg = meta.get('packages', {}).get('nix', '') -%}
          {%-     if nix_pkg and (preferred_manager == 'nix' or os_pkg == '') -%}
          {%-       set _ = pkgs.append(nix_pkg) -%}
          {%-     endif -%}
          {%-   endfor -%}
          {%- endfor -%}
          {{ pkgs | unique | sort }}


    - name: Install OS packages (macOS)
      ansible.builtin.homebrew:
        name: "{{ os_packages }}"
        state: present
      become: true
      when:
        - os_key == 'macos'
        - os_packages | length > 0

    - name: Install OS packages (Linux)
      ansible.builtin.package:
        name: "{{ os_packages }}"
        state: present
      become: true
      when:
        - os_key == 'linux'
        - os_packages | length > 0

    - name: Check for nix
      ansible.builtin.shell: command -v nix
      register: nix_command
      changed_when: false
      failed_when: false
      when: use_nix | bool
      environment:
        PATH: "{{ nix_path }}"

    - name: Fetch nix tags from GitHub
      ansible.builtin.uri:
        url: https://api.github.com/repos/NixOS/nix/tags
        return_content: true
      register: nix_github_tags
      when:
        - use_nix | bool
        - nix_command.rc != 0
        - os_key == 'linux'
        - ansible_facts['os_family'] == 'Debian'

    - name: Set nix version from GitHub
      ansible.builtin.set_fact:
        nix_version: >-
          {{
            (nix_github_tags.json | default([]) | first | default({})).name
            | default('')
          }}
      when:
        - use_nix | bool
        - nix_command.rc != 0
        - os_key == 'linux'
        - ansible_facts['os_family'] == 'Debian'

    - name: Fail if nix version could not be determined
      ansible.builtin.fail:
        msg: "Failed to determine latest nix version."
      when:
        - use_nix | bool
        - nix_command.rc != 0
        - os_key == 'linux'
        - ansible_facts['os_family'] == 'Debian'
        - nix_version | length == 0

    - name: Note nix installer URLs
      ansible.builtin.set_fact:
        nix_install_url: "https://releases.nixos.org/nix/nix-{{ nix_version }}/install"
        nix_install_checksum_url: "https://releases.nixos.org/nix/nix-{{ nix_version }}/install.sha256"
      when:
        - use_nix | bool
        - nix_command.rc != 0
        - os_key == 'linux'
        - ansible_facts['os_family'] == 'Debian'

    - name: Install nix (daemon, verified)
      block:
        - name: Create temp dir for nix installer
          ansible.builtin.tempfile:
            state: directory
            suffix: nix-install
          register: nix_tmp

        - name: Download nix installer
          ansible.builtin.get_url:
            url: "{{ nix_install_url }}"
            dest: "{{ nix_tmp.path }}/install"
            mode: "0755"
            checksum: "sha256:{{ nix_install_checksum_url }}"

        - name: Run nix installer (daemon)
          ansible.builtin.command: "{{ nix_tmp.path }}/install --daemon"
          environment:
            PATH: "/usr/sbin:/sbin:{{ ansible_facts['env']['PATH'] }}"

        - name: Enable nix-command and flakes
          ansible.builtin.copy:
            dest: /etc/nix/nix.conf
            content: |
              experimental-features = nix-command flakes
            mode: "0644"
      become: true
      when:
        - use_nix | bool
        - nix_command.rc != 0
        - os_key == 'linux'
        - ansible_facts['os_family'] == 'Debian'

    - name: Read enabled categories from home-manager tools file
      ansible.builtin.command: >-
        nix eval --raw --impure --expr
        "let lib = import <nixpkgs/lib>;
         tools = ((import {{ ansible_facts['user_dir'] }}/.config/home-manager/tools.nix) {}).tiers or {};
         in (builtins.concatStringsSep \" \" (builtins.attrNames (lib.filterAttrs(name: value: value.enable) tools)))"
      environment:
        PATH: "{{ nix_path }}"
      register: hm_enabled
      changed_when: false
      failed_when: false
      when:
        - use_nix | bool
        - nix_packages | length > 0

    - name: Build home-manager tools file content
      ansible.builtin.set_fact:
        hm_tools_file: "{{ ansible_facts['user_dir'] }}/.config/home-manager/tools.nix"
        hm_enabled_categories: "{{ (hm_enabled.stdout | default('') | trim | regex_replace('\\s+', ' ') | split(' ') | reject('equalto', '') | list) }}"
        hm_all_categories: "{{ (categories_list + (hm_enabled.stdout | default('') | trim | regex_replace('\\s+', ' ') | split(' ') | reject('equalto', '') | list)) | unique | sort }}"
        hm_tools_content: >-
          { ... }: {
            tiers = {
          {%- for cat in (categories_list + (hm_enabled.stdout | default('') | trim | regex_replace('\\s+', ' ') | split(' ') | reject('equalto', '') | list)) | unique | sort -%}
              {{ cat }}.enable=true;
          {%- endfor -%}
            };
          }
      when:
        - use_nix | bool
        - nix_packages | length > 0

    - name: Configure nix packages
      ansible.builtin.copy:
        dest: "{{ hm_tools_file }}"
        content: "{{ hm_tools_content }}"
      when:
        - use_nix | bool
        - nix_packages | length > 0

    - name: Check for home-manager
      ansible.builtin.shell: command -v home-manager
      register: hm_command
      changed_when: false
      failed_when: false
      when:
        - use_nix | bool
        - nix_packages | length > 0
      environment:
        PATH: "{{ nix_path }}"

    - name: Run home-manager switch
      ansible.builtin.command: home-manager switch
      when:
        - use_nix | bool
        - nix_packages | length > 0
        - hm_command.rc == 0
      environment:
        PATH: "{{ nix_path }}"

    - name: Run home-manager via nix
      ansible.builtin.command: nix run home-manager/release-25.05 -- switch
      when:
        - use_nix | bool
        - nix_packages | length > 0
        - hm_command.rc != 0
      environment:
        PATH: "{{ nix_path }}"
