#!/usr/bin/env bash

[[ "$(uname -o)" != "Msys" ]] || exec pwsh -nologo $HOME/.local/bin/install-tools.ps1 "$@"

function _sudo() {
  echo sudo "$@"
  sudo "$@"
}

function _read_packages() {
  local filename="$1"
  shift
  local -a categories=("$@")
  local -a packages=()
  for category in "${categories[@]}"; do
    local packages_file="$XDG_DATA_HOME/chris468/tools/$category/$filename"
    [[ -f "$packages_file" ]] || continue
    cat "$packages_file"
  done
}

function install_darwin() {
  local -a categories=("$@")
  local -a packages=($(_read_packages packages.txt "${categories[@]}"))
  [[ -n "${packages[*]}" ]] || return 0
  echo
  echo "Installing tool homebrew packages for ${categories[*]}..."
  brew install "${packages[@]}"
}

function install_os_packages() {
  local -a categories=("$@")
  local -a packages=($(_read_packages packages.txt "${categories[@]}"))
  [[ -n "${packages[*]}" ]] || return 0

  echo
  echo "Installing tool pacman packages for ${categories[*]}..."
  _sudo pacman -S "${packages[@]}" --needed || true
}

function _get_enabled_categories() {
  local expr
  expr=$(
    cat <<EOF
let
  lib = import <nixpkgs/lib>;
  tools = ((import $HOME/.config/home-manager/tools.nix) {}).tiers or {};
in
  (builtins.concatStringsSep " " (builtins.attrNames (lib.filterAttrs(name: value: value.enable) tools)))
EOF
  )
  nix eval --raw --impure --expr "$expr"
}

function _configure_home_manager_tools() {
  local -a categories=("$@")
  categories+=($(_get_enabled_categories))

  local enables=
  for category in "${categories[@]}"; do
    local seen_v=seen_$category
    [[ -z "${!seen_v}" ]] || continue
    local seen_$category=1
    enables="$(printf "%s\n    %s.enable=true;" "$enables" "$category")"
  done

  cat <<EOF >$HOME/.config/home-manager/tools.nix
{ ... }: {
  tiers = {$enables
  };
}
EOF
}

function install_nix_packages() {
  local -a categories=("$@")

  _configure_home_manager_tools "${categories[@]}"
  _home_manager=home_manager
  get-command -v $_home_manager >&/dev/null || _home_manager="nix run home-manager/release-25.05 -- "
  $_home_manager switch
}

function install_linux() {
  local -a categories=("$@")

  install_os_packages "${categories[@]}"
  install_nix_packages "${categories[@]}"
}

function install_nerd_font() {
  local -a categories=("$@")
  local -a fonts=($(_read_packages nerdfonts.txt "${categories[@]}"))
  [[ -n "${fonts[*]}" ]] || return 0

  echo
  echo "Installing nerd fonts for ${categories[*]}..."
  for font in "${fonts[@]}"; do
    oh-my-posh font install "$font"
  done
}

declare -ar ORDER=(essential container kubernetes aws azure)
ALL=
ANY=
FONTS=1
for category in "${ORDER[@]}"; do
  declare "category_$category"
done

while [[ $# -gt 0 ]]; do
  case "$1" in
  --all)
    ALL=1
    break
    ;;

  --no-fonts)
    FONTS=
    shift
    ;;

  --*)
    c="${1#--}"
    [[ -d "$XDG_DATA_HOME/chris468/tools/$c" ]] || {
      echo "Unknown option: $1" >&2
      exit 1
    }

    declare "category_$c"=1
    ANY=1
    shift
    ;;

  *)
    echo "Unknown option: $1" >&2
    exit 1
    ;;
  esac
done

[[ -n "$ANY" ]] || category_essential=1

# Force sudo to prompt for a password
! command -v sudo >&/dev/null || sudo -k

# Remove everything before / to convert GNU/Linux to Linux
# Convert upper to lower
OS=$(uname -o | sed -E 's|^.*/||' | tr '[:upper:]' '[:lower:]')
declare -a INSTALL_CATEGORIES=()
for category in "${ORDER[@]}"; do
  v="category_$category"
  [[ -n "$ALL" ]] || [[ -n "${!v}" ]] || continue
  INSTALL_CATEGORIES+=("$category")
done

"install_$OS" "${INSTALL_CATEGORIES[@]}"
[[ -z "$FONTS" ]] || install_nerd_font "${INSTALL_CATEGORIES[@]}"
